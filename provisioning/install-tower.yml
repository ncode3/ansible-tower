---
- vars:
    packages: ['deltarpm','bash-completion','vim-enhanced','net-snmp','ntp','ntpdate','git','wget']
    enabled_svcs: ['sshd','network','rsyslog']
    disabled_svcs: ['NetworkManager']
    rh_subscription_pools: ['1234','5678']
    rh_enabled_repos: ['rhel-7-server-optional-rpms','rhel-7-server-rpms','rhel-7-server-extras-rpms']
    rh_disabled_repos: ['*']
    rh_satellite_url: https://subscription.rhn.redhat.com
    rh_satellite_org: None
    rh_satellite_user: username
    rh_satellite_pass: password
    tower_tarball_location: http://10.55.3.153/ansible-tower-setup-latest.tar.gz
# if you had a valuted file, you would put include it here
#- include_vars: secrets.yml

- name: "Set up /etc/hosts file"
  shell: |
    hostname=$(hostname)
    shortname=$(hostname --short)
    newip=$(ip addr list eth0 | grep 'inet ' | cut -d ' ' -f 6 | cut -d / -f1)
    grep "${newip}" /etc/hosts || echo "${newip} ${hostname} ${shortname}" >> /etc/hosts
  become: true

- name: "Enabling and restarting services {{ enabled_svcs }}"
  service:
    name: "{{ item }}"
    state: restarted
    enabled: yes
  with_items: "{{ enabled_svcs }}"
  become: true

- name: "Stopping and disabling services {{ disabled_svcs }}"
  service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  with_items: "{{ disabled_svcs }}"
  become: true

- name: Register and subscribe to multiple pools.
  redhat_subscription:
    state: present
    username: "{{ rh_satellite_user }}"
    password: "{{ rh_satellite_pass }}"
    pool_ids: "{{ rh_subscription_pools }}"
  become: true

- name: "Disabling all repos"
  shell: "subscription-manager repos --disable={{ item }}"
  with_items: "{{ rh_disabled_repos }}"
  become: true

- name: "Enabling needed repos"
  shell: "subscription-manager repos --enable={{ item }}"
  with_items: "{{ rh_enabled_repos }}"
  become: true

- name: "Installing rpms {{ packages }}"
  yum:
    name: "{{ item }}"
    state: latest
  with_items: "{{ packages }}"
  become: true

- name: "Custom configuration repo"
  file:
    path: /opt/git
    state: directory
    mode: 0755
    
- git:
    repo: 'https://github.com/syspimp/kubernetes-demo.git'
    dest: /opt/git

- name: Updating MOTD
  shell: cat custom/tiger.ascii > /etc/motd
  args:
    chdir: /opt/git/kubernetes-demo
  become: true

- unarchive:
    src: "{{ tower_tarball_location }}"
    dest: /opt
    remote_src: True

- name: Run expect to wait for a successful PXE boot via out-of-band CIMC
  shell: |
    cd ansible-tower-setup-*
    sed -i -e "s/admin_password=''/admin_password='ansible'/g" inventory
    sed -i -e "s/redis_password=''/redis_password='ansible'/g" inventory
    sed -i -e "s/pg_password=''/pg_password='ansible'/g" inventory
    sed -i -e "s/rabbitmq_password=''/rabbitmq_password='ansible'/g" inventory
  args:
    chdir: /opt

- name: Install Tower
  shell: |
    cd ansible-tower-setup-*
    ./setup.sh
  args:
    chdir: /opt
  become: true
