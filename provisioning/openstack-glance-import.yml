---
- name: "Import glance images from nfs share"
  hosts: 10.55.102.158
  tasks:
    - name: "Create lab project and user"
      shell: |
        . /root/keystonerc_admin
        openstack project create --description "{{ openstack['project_name'] }}" {{ openstack['project_name'] }}
        openstack user create --project {{ openstack['project_name'] }} --password {{ openstack['project_pass'] }} {{ openstack['project_user'] }}
      args:
        chdir: /root
      become: true
      ignore_errors: yes

    - name: "copy over dtaylor keystone file"
      template:
        src: "openstack/keystonerc_{{ openstack['project_user'] }}.j2"
        dest: "/root/keystonerc_{{ openstack['project_user'] }}"
        owner: root
        group: root
        mode: 0644

    - name: "copy over glance import script"
      template:
        src: openstack/glance-import.sh.j2
        dest: /root/glance-import.sh
        owner: root
        group: root
        mode: 0755
        
    - name: "make the import directory"
      file:
        path: /mnt/compute1/glance-images
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: this is used by openstack dnsmasq to update the applications dns entry
      template:
        src: openstack/dns-updater.sh.j2
        dest: /usr/local/bin/dns-updater.sh
        owner: root
        group: root
        mode: 0755

    - name: openstack dnsmasq config file
      template:
        src: openstack/dnsmasq.conf.j2
        dest: /etc/neutron/dnsmasq.conf
        owner: root
        group: root
        mode: 0644

    - name: update neutron dhcp_agent.ini dns values
      lineinfile: 
        line: "dnsmasq_dns_servers = {{ openstack['dns_server'] }}"
        dest: /etc/neutron/dhcp_agent.ini
        regexp: "^#dnsmasq_dns_servers ="
        state: present

    - name: update neutron dhcp_agent.ini domain values
      lineinfile: 
        line: "dhcp_domain = {{ openstack['dhcp_domain'] }}"
        dest: /etc/neutron/dhcp_agent.ini
        regexp: "^#dhcp_domain ="
        state: present

    - name: update neutron dhcp_agent.ini config file values
      lineinfile:
        line: "dnsmasq_config_file = /etc/neutron/dnsmasq.conf"
        dest: /etc/neutron/dhcp_agent.ini
        regexp: "^#dnsmasq_config_file ="
        state: present

    - name: update nova.conf domain values
      lineinfile:
        line: "dhcp_domain={{ openstack['dhcp_domain'] }}"
        dest: /etc/nova/nova.conf
        regexp: "^#dhcp_domain="
        state: present

    - name: "Enabling and restarting services openstack nova and neutron-dhcp-agent services"
      service:
        name: "{{ item }}"
        state: restarted
        enabled: yes
      with_items:
        - neutron-dhcp-agent
        - openstack-nova-api
        - openstack-nova-cert
        - openstack-nova-consoleauth
        - openstack-nova-scheduler
        - openstack-nova-conductor
        - openstack-nova-novncproxy 
      become: true

    - name: "Mount nfs share to import glance images"
      mount:
        path: /mnt/compute1/glance-images
        src: 10.55.2.155:/mnt/drobo/software/BackUp/openstack/glance-images
        fstype: nfs
        opts: noauto,x-systemd.automount,x-systemd.device-timeout=10,timeo=14,x-systemd.idle-timeout=1min
        state: present

    - name: "Import a couple of glance images ..."
      shell: |
        mount /mnt/compute1/glance-images
        /root/glance-import.sh  -f /mnt/compute1/glance-images/RHEL-7.3-Cloud-bare.qcow2
        /root/glance-import.sh  -f /mnt/compute1/glance-images/RHEL-Atomic-7.2.6-1-bare.qcow2
        /root/glance-import.sh  -f /mnt/compute1/glance-images/PXE-client-bare.raw
      args:
        chdir: /root
      become: true

